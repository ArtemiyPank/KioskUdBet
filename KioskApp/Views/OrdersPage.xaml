<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:KioskApp.ViewModels"
             x:Class="KioskApp.Views.OrdersPage"
             Title="Orders"
             BackgroundColor="{DynamicResource PrimaryBackgroundColor}">

    <!-- Обновлённые локальные стили для заголовков и деталей -->
    <ContentPage.Resources>
        <Style x:Key="HeaderLabelStyle"
               TargetType="Label">
            <Setter Property="FontSize"
                    Value="14" />
            <Setter Property="FontAttributes"
                    Value="Bold" />
            <!-- Используем динамический ресурс для текста -->
            <Setter Property="TextColor"
                    Value="{DynamicResource PrimaryTextColor}" />
        </Style>
        <Style x:Key="DetailLabelStyle"
               TargetType="Label">
            <Setter Property="FontSize"
                    Value="12" />
            <Setter Property="TextColor"
                    Value="{DynamicResource PrimaryTextColor}" />
        </Style>
    </ContentPage.Resources>

    <StackLayout Padding="10">
        <!-- Кнопка для ручной перезагрузки заказов -->
        <Button Text="Reload Orders"
                Command="{Binding ReloadOrdersCommand}"
                Margin="0,10,0,0"
                BackgroundColor="{DynamicResource ButtonBackgroundColor}"
                TextColor="{DynamicResource PrimaryTextColor}" />

        <!-- ListView для отображения всех заказов -->
        <ListView ItemsSource="{Binding Orders}"
                  HasUnevenRows="True"
                  SeparatorVisibility="None"
                  BackgroundColor="{DynamicResource PrimaryBackgroundColor}">
            <ListView.ItemTemplate>
                <DataTemplate>
                    <ViewCell>
                        <Frame HasShadow="False"
                               Padding="5"
                               Margin="2"
                               BorderColor="{DynamicResource AccentColor}"
                               BackgroundColor="{DynamicResource SecondaryBackgroundColor}"
                               CornerRadius="8">
                            <StackLayout Spacing="8">
                                <!-- Заголовок заказа с основными данными -->
                                <Grid ColumnSpacing="5">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <!-- Информация о заказе -->
                                    <Label Text="Order Details"
                                           Style="{StaticResource HeaderLabelStyle}"
                                           Grid.Row="0"
                                           Grid.Column="0" />
                                    
                                    <Label Text="{Binding Status}"
                                           Style="{StaticResource DetailLabelStyle}"
                                           TextColor="DarkBlue"
                                           Grid.Row="0"
                                           Grid.Column="1"
                                           HorizontalTextAlignment="End" />
                                    
                                    <Label Text="{Binding User.FullName}"
                                           Grid.Row="1"
                                           Grid.Column="0" />

                                    <Label Text="{Binding Building}"
                                           Style="{StaticResource DetailLabelStyle}"
                                           Grid.Row="1"
                                           Grid.Column="1"
                                           HorizontalTextAlignment="End" />
                                </Grid>

                                <!-- Информация о доставке и номере комнаты -->
                                <Grid ColumnSpacing="5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <Label Text="{Binding DeliveryStartTime, StringFormat='Delivery: {0:HH:mm} - {1:HH:mm}'}"
                                           Style="{StaticResource DetailLabelStyle}"
                                           Grid.Column="0" />
                                    <Label Text="{Binding RoomNumber}"
                                           Style="{StaticResource DetailLabelStyle}"
                                           Grid.Column="1"
                                           HorizontalTextAlignment="End" />
                                </Grid>

                                <!-- Заголовок для списка товаров заказа -->
                                <Label Text="Order Items:"
                                       Style="{StaticResource HeaderLabelStyle}" />

                                <!-- Коллекция для отображения товаров заказа в виде сетки -->
                                <CollectionView ItemsSource="{Binding OrderItems}">
                                    <CollectionView.ItemsLayout>
                                        <GridItemsLayout Orientation="Vertical"
                                                         Span="2" />
                                    </CollectionView.ItemsLayout>
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Frame HasShadow="False"
                                                   Padding="5"
                                                   Margin="2"
                                                   BorderColor="{DynamicResource AccentColor}"
                                                   BackgroundColor="{DynamicResource SecondaryBackgroundColor}"
                                                   CornerRadius="5">
                                                <StackLayout Spacing="2">
                                                    <!-- Название продукта -->
                                                    <Label Text="{Binding Product.Name}"
                                                           Style="{StaticResource DetailLabelStyle}"
                                                           LineBreakMode="TailTruncation" />
                                                    <!-- Количество товара -->
                                                    <Label Text="{Binding Quantity, StringFormat='Qty: {0}'}"
                                                           Style="{StaticResource DetailLabelStyle}" />
                                                    <!-- Цена продукта -->
                                                    <Label Text="{Binding Product.Price, StringFormat='Price: {0:C}'}"
                                                           Style="{StaticResource DetailLabelStyle}" />
                                                </StackLayout>
                                            </Frame>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>

                                <!-- Кнопка обновления статуса заказа -->
                                <Button Text="Update Status"
                                        FontSize="12"
                                        Padding="5"
                                        Command="{Binding UpdateOrderStatusCommand, Source={RelativeSource AncestorType={x:Type vm:OrdersViewModel}}}"
                                        CommandParameter="{Binding .}"
                                        HorizontalOptions="End"
                                        BackgroundColor="{DynamicResource ButtonBackgroundColor}"
                                        TextColor="{DynamicResource PrimaryTextColor}" />
                            </StackLayout>
                        </Frame>
                    </ViewCell>
                </DataTemplate>
            </ListView.ItemTemplate>
        </ListView>
    </StackLayout>
</ContentPage>
